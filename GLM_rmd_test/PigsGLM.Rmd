---
title: "GLM - Pigs"
output:
  html_document:
    toc: true
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background

![Graphical representation of the model.](Blank%20diagram.png){width="400"}

Ideas behind the model:

-   *Demand* and *Investment* are unknown and cannot be estimated: in a sense, `Pigs` % might help in estimating them.

-   `Chronology` influences the *demand* (more or less people, dietary preferences, etc.) and the site `Type` (as some sites do not exist in other chronologies, or settlement patterns change).

-   The site `Type` influences the *investment* (low to high) and consequently the pigs husbandry.

-   *Investment* is also influenced by *demand* (again, low to high). For instance, sites with high demand are `Fortified` or `Urban` sites. Sites with high investment might be `Villas` in the Late Roman phase.

-   The `Macroregion` is an important confounding variable, as it shows diverging trends for `Pigs` %.

# Data processing

```{r message=FALSE}

####################
## Data pre-processing
####################

library(here)
library(tidyverse)

Animals_Df <- read.csv(here("/Users/robertoragno/Downloads/betabin_test/Zooarch_Condensed_with_altitude.csv"), header=TRUE, sep=";")

Animals_Df$Tot_NISP <- rowSums(Animals_Df[c(16:22)], na.rm = T)

# 1. Subsetting the dataframe
Animals_Df <- Animals_Df[c(1,16,17,18,20,25,4,5,6,7,10)]

# 2. Merge some categories in the 'Type' column
Animals_Df$Type <- str_replace(Animals_Df$Type, "Rural site, mansio", "Rural")      
Animals_Df$Type <- str_replace(Animals_Df$Type, "Religious, monastery", "Religious")
Animals_Df$Type <- str_replace(Animals_Df$Type, "Castle", "Fortified")
Animals_Df$Type <- str_replace(Animals_Df$Type, "Castrum", "Fortified")
Animals_Df$Geo <- str_replace(Animals_Df$Geo, "Hilltop", "Hill")

# 3. Remove the categories 'Necropolis' and 'Religious' as they might skew
# the results.
Animals_Df <- filter(Animals_Df, Type!="Necropolis" & Type!="Religious" & Type!="Shipwreck" & Type!="Urban, amphitheater")

# 4. Exclude the castrum of Ostia, very strong outlier and regardless only fortified
# roman site
Animals_Df <- subset(Animals_Df, !(Chronology=="R" & Type=="Fortified"))

# Convert to factors
Animals_Df[,c(7:9,11)] <- lapply(Animals_Df[,c(7:9,11)], factor)

# Specify chronological order
Animals_Df$Chronology <- factor(Animals_Df$Chronology, levels = c("R", "LR", "EMA", "Ma"))

# Convert NAs to 0
Animals_Df[is.na(Animals_Df)]<-0

# Create copies
Animals_Df2 <- Animals_Df
Animals_Df_fort <- Animals_Df
Animals_Df_villas <- Animals_Df

# Convert to proportions just the 
Animals_Df[,c(2:5)] <- Animals_Df[,c(2:5)]/Animals_Df$Tot_NISP

# Simplifying: Urban vs Rural
Animals_Df2 <- subset(Animals_Df2, Type=="Rural" | Type=="Urban")
Animals_Df2 <- droplevels(Animals_Df2)

Animals_Df_fort <- subset(Animals_Df_fort, Type=="Fortified")
Animals_Df_fort <- droplevels(Animals_Df_fort)

Animals_Df_villas <- subset(Animals_Df_villas, Type=="Rural site, villa")
Animals_Df_villas <- droplevels(Animals_Df_villas)
```

```{r echo=FALSE}
print("Number of samples:")
table(Animals_Df$Chronology)


print("Chronological means and sd:")
Animals_Df %>% 
  group_by(Chronology) %>% 
  summarise(mean = mean(Pigs, na.rm = T), 
            SD = sd(Pigs, na.rm = T)) %>% 
  mutate_if(is.numeric, ~round(., 2))


```

Plots showing very high variability in each site type:

```{r}
#| echo: false
Animals_Df %>% 
  ggplot(aes(Pigs)) + 
  geom_density() +
  facet_wrap(Chronology~Type)
```

# Test 3: Rethinking

Formula: $$P_{i} \sim BetaBinomial(NISP_{i}, \bar{p}_{i} , \Theta )$$

$$
logit(\bar{p}_{i}) = \alpha_{[TCid]}
$$

$$
\alpha_{j} \sim Normal(0,1.5)
$$

$$
\Theta = \phi + 2
$$

$$
\phi \sim Exponential(1)
$$

```{r}
#| warning: false
#| message: false

library(rethinking)

d <- Animals_Df2
d$TC_id <- as.integer(interaction(d$Type, d$Chronology))
dat <-  list( P=d$Pigs , N=d$Tot_NISP , TC_id=d$TC_id )

# pbar is the mean of the distribution

m12.1 <- ulam(
    alist(
        P ~ dbetabinom( N , pbar , theta ),
        logit(pbar) <- a[TC_id],
        a[TC_id] ~ dnorm( 0 , 1.5 ),
        transpars> theta <<- phi + 2.0,
        phi ~ dexp(1)
    ), data=dat , chains=4
    )


post <- extract.samples( m12.1 )
precis( post , depth=2 )

# postcheck( m12.1 )

```

The formula that I ideally would like to use is something like: Formula: $$P_{i} \sim BetaBinomial(NISP_{i}, \bar{p}_{i} , \Theta )$$

$$
logit(\bar{p}_{i}) = \alpha_{[TCid]}
$$

$$
\alpha_{j} \sim Normal(0,1.5)
$$

$$
\Theta = \phi_{[TCid]} + 2
$$

$$
\phi_{j} \sim Exponential(1)
$$

However, judging from the previous STAN output (m12.1) it seems like $\Theta$ is already varying according to the index TC_id (as it is iteratively multiplied by pbar) although I am not getting what I need: phi[1], phi[2], etc. 

    model { 
        vector[425] pbar; 
        phi ~ exponential( 1 ); 
        a ~ normal( 0 , 1.5 ); 

      for ( i in 1:425 ) { 
        pbar[i] = a[TC_id[i]]; 
        pbar[i] = inv_logit(pbar[i]); 
        } 

    P ~ beta_binomial( N , pbartheta , (1-pbar)theta ); 

    }

Anyway, if I try to implement the second formula above I get an error:

    Compiling Stan program...
    Semantic error in '/var/folders/dw/r9gz57kj7lxbvc5mg1phwpcc0000gn/T/RtmpzGAAzl/model-ea8976b45961.stan', line 22, column 27 to column 37:
       -------------------------------------------------
        20:          pbar[i] = inv_logit(pbar[i]);
        21:      }
        22:      P ~ beta_binomial( N , pbar*theta , (1-pbar)*theta );
                                        ^
        23:  }
        24:  
       -------------------------------------------------

    Ill-typed arguments supplied to infix operator *. 

    Instead supplied arguments of incompatible type: vector, vector.

```{r}
#| eval: false
#| echo: true

m12.2 <- ulam(
    alist(
         P ~ dbetabinom( N , pbar , theta ),
         logit(pbar) <- a[TC_id],
         a[TC_id] ~ dnorm( 0 , 1.5 ),
         theta <- phi[TC_id] + 2.0,
         phi[TC_id] ~ dexp(1)
    ), data=dat, chains=4
     )

```

```{r}
#| eval: false
#| echo: false
library(modelr)
library(tidybayes.rethinking)
library(tidybayes)

as.data.frame(dat) %>%
  data_grid(TC_id) %>%
  add_linpred_draws(m12.1) %>%
  ggplot(aes(x = .linpred, y = fct_rev(as.factor(TC_id)))) +
  stat_pointinterval(.width = c(.66, .95))+
  labs(x="Prediction",
       y="Type:Chronology",
       title="Pigs",
       caption="Type:Chronology = (1) R:Rur, (2): R:Urb, (3) LR:Rur,\n (4) LR:Urb, (5) EMA:Rur, (6) EMA:Urb,\n (7) Ma:Rur, (8) Ma:Urb")+
  theme_tidybayes()

```

```{r}
#| echo: false
#| eval: false

# PLOTS

# Function to create plot for the distribution

make_post_plot <- function(post, TC_id) {
  library(ggplot2)
  library(ggpubr)
  
  curve_data <- as.data.frame(
    curve(
      rethinking::dbeta2(x, mean(logistic(post$a[, TC_id])), mean(post$theta)), 
      from = 0, to = 1
    )
  )
  
  plot <- ggplot() +
    geom_line(data = curve_data, aes(x = x, y = y),
              color = "orange", linewidth = 0.5, alpha = 0.9, linetype = 1)+
    xlab("Probability") +
    ylab("Density") +
    xlim(0, 1) +
    ylim(0, 3) +
    theme_pubclean()
  
  for (i in 1:50) {
    # calculate the parameters for the beta distribution
    p_beta <- logistic(post$a[i, TC_id])
    theta <- post$theta[i]
    # calculate the y values for the beta distribution
    y <- dbeta2(x, p_beta, theta)
    # create a new data frame with x and y columns
    df_beta <- data.frame(x = x, y = y)
    # add the curve to the plot using geom_line
    plot <- plot + geom_line(data = df_beta, aes(x = x, y = y),
                             color = "orange3", alpha = 0.1, linetype = 1)
  }
  
  return(plot)
}

# TC_id:
# (1) R:Rur, (2): R:Urb, (3) LR:Rur, (4) LR:Urb, (5) EMA:Rur, (6) EMA:Urb, (7) Ma:Rur, (8) Ma:Urb

library(patchwork)

(make_post_plot(post, 1) + ggtitle("Pigs - Roman rural sites")+make_post_plot(post, 2) + ggtitle("Pigs - Roman urban sites")) / (make_post_plot(post, 3) + ggtitle("Pigs - Late Roman rural sites")+make_post_plot(post, 4) + ggtitle("Pigs - Late Roman urban sites")) / (make_post_plot(post, 5) + ggtitle("Pigs - EMA rural sites")+make_post_plot(post, 6) + ggtitle("Pigs - EMA urban sites")) / (make_post_plot(post, 7) + ggtitle("Pigs - 11th c. rural sites")+make_post_plot(post, 8) + ggtitle("Pigs - 11th c. urban sites"))


```
