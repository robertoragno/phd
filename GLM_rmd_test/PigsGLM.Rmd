---
title: "GLM - Pigs"
output:
  html_document:
    toc: true
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background

![Graphical representation of the model.](Blank%20diagram.png){width="400"}

Ideas behind the model:

-   *Demand* and *Investment* are unknown and cannot be estimated: in a sense, `Pigs` % might help in estimating them.

-   `Chronology` influences the *demand* (more or less people, dietary preferences, etc.) and the site `Type` (as some sites do not exist in other chronologies, or settlement patterns change).

-   The site `Type` influences the *investment* (low to high) and consequently the pigs husbandry.

-   *Investment* is also influenced by *demand* (again, low to high). For instance, sites with high demand are `Fortified` or `Urban` sites. Sites with high investment might be `Villas` in the Late Roman phase.

-   The `Macroregion` is an important confounding variable, as it shows diverging trends for `Pigs` %.

# Data processing

```{r message=FALSE}
####################
## Data pre-processing
####################

library(here)
library(tidyverse)

Animals_Df <- read.csv(here("Zooarch_Condensed_with_altitude.csv"), header=TRUE, sep=";")

Animals_Df$Tot_NISP <- rowSums(Animals_Df[c(16:22)], na.rm = T)

# 1. Subsetting the dataframe
Animals_Df <- Animals_Df[c(1,16,17,18,20,25,4,5,6,7,10)]

# 2. Merge some categories in the 'Type' column
Animals_Df$Type <- str_replace(Animals_Df$Type, "Rural site, mansio", "Rural")      
Animals_Df$Type <- str_replace(Animals_Df$Type, "Religious, monastery", "Religious")
Animals_Df$Type <- str_replace(Animals_Df$Type, "Castle", "Fortified")
Animals_Df$Type <- str_replace(Animals_Df$Type, "Castrum", "Fortified")
Animals_Df$Geo <- str_replace(Animals_Df$Geo, "Hilltop", "Hill")

# 3. Remove the categories 'Necropolis' and 'Religious' as they might skew
# the results.
Animals_Df <- filter(Animals_Df, Type!="Necropolis" & Type!="Religious" & Type!="Shipwreck" & Type!="Urban, amphitheater")

# 4. Exclude the castrum of Ostia, very strong outlier and regardless only fortified
# roman site
Animals_Df <- subset(Animals_Df, !(Chronology=="R" & Type=="Fortified"))

# Convert to factors
Animals_Df[,c(7:9,11)] <- lapply(Animals_Df[,c(7:9,11)], factor)

# Specify chronological order
Animals_Df$Chronology <- factor(Animals_Df$Chronology, levels = c("R", "LR", "EMA", "Ma"))

# Convert NAs to 0
Animals_Df[is.na(Animals_Df)]<-0

# Create copies
Animals_Df2 <- Animals_Df
Animals_Df_fort <- Animals_Df
Animals_Df_villas <- Animals_Df

# Convert to proportions just the 
Animals_Df[,c(2:5)] <- Animals_Df[,c(2:5)]/Animals_Df$Tot_NISP

# Simplifying: Urban vs Rural
Animals_Df2 <- subset(Animals_Df2, Type=="Rural" | Type=="Urban")
Animals_Df2 <- droplevels(Animals_Df2)

Animals_Df_fort <- subset(Animals_Df_fort, Type=="Fortified")
Animals_Df_fort <- droplevels(Animals_Df_fort)

Animals_Df_villas <- subset(Animals_Df_villas, Type=="Rural site, villa")
Animals_Df_villas <- droplevels(Animals_Df_villas)
```

```{r echo=FALSE}
print("Number of samples:")
table(Animals_Df$Chronology)


print("Chronological means and sd:")
Animals_Df %>% 
  group_by(Chronology) %>% 
  summarise(mean = mean(Pigs, na.rm = T), 
            SD = sd(Pigs, na.rm = T)) %>% 
  mutate_if(is.numeric, ~round(., 2))


```

Plots showing very high variability in each site type:

```{r}
#| echo: false
Animals_Df %>% 
  ggplot(aes(Pigs)) + 
  geom_density() +
  facet_wrap(Chronology~Type)
```

# Test 1: GLMM with BRMS

Ideally, bayesian GLMMs would be the way I would like to go forward. However, I am finding it hard to understand the meaning of the diagnostics and `summary()` call of the model. I know I should look at the caterpillar plots to look for convergence, at the rhat value, and that I should have large enough tails. I find however hard to make sense of the intercept estimate and other estimates (in the population-level effects).

Questions:

-   The group-level effects (`~ID`) should tell me in the sd(Intercept) how much is the variation between sites. Is this correct?

-   At the moment, I have added priors using the `get_prior()` function, which should provide weakly informative priors generated based on the dataset and distribution I want to use. How can I add (weakly informative) priors that are based on my beliefs? For instance that pigs should be higher in urban and fortified sites, higher in late Roman villas, higher in places close to forests in the early Middle ages, etc. This is something that might have to be done in Stan. I am not set on `brms`, I am just using this because of the tutorials I have found online and because it allows for the betabinomial distribution.

-   I have copied a code to get the posterior distribution of the intercept, but I think that is too general and I am not sure about how to read it. The boxplots do give me some more information, in the % scale (I think?) which I would like to have for publication, but ideally I'd love to have density distributions with confidence intervals. I do not know if it is simply a matter of extracting the right values, because I am not entirely sure where to get those values.

```{r}
#| eval: true
#| message: false
#| output: false

# Load brms
library(brms)

# Create priors
prior <- get_prior(
  Pigs|trials(Tot_NISP) ~ 1 + Type*Chronology + (1|ID), 
  data = Animals_Df2, beta_binomial())

pigs_glm_mod <- brm(Pigs|trials(Tot_NISP) ~ 1 + Type*Chronology + (1|ID),
                    data = Animals_Df2,
                    beta_binomial(),
                    prior=prior,
                    iter=2000,
                    warmup = 500,
                    chains = 2, 
                    cores = 4,
                    seed=123
                    )

summary(pigs_glm_mod)
```

```{r}
#| echo: false
post <- posterior_samples(pigs_glm_mod, add_chain = T)

library(ggthemes)
post %>% 
  sample_n(100) %>% 
  expand(nesting(iter, b_Intercept, sd_ID__Intercept),
         x = seq(from = -4, to = 5, length.out = 100)) %>% 
  ggplot(aes(x = x, group = iter)) +
  geom_line(aes(y = dnorm(x, b_Intercept, sd_ID__Intercept)),
            alpha = .2, color = "orange2") +
  labs(title = "Pigs population distribution",
       subtitle = "The Gaussians are on the log-odds scale.") +
  scale_y_continuous(NULL, breaks = NULL) +
  coord_cartesian(xlim = c(-3, 4)) + 
  theme_fivethirtyeight() +
  theme(plot.title    = element_text(size = 13),
        plot.subtitle = element_text(size = 10))

```

```{r}
#| echo: false
#| eval: true
#| message: false

# plot(pigs_glm_mod)

print("ICC Scores:")

performance::icc(pigs_glm_mod)

pp_check(pigs_glm_mod)

conditional_effects(pigs_glm_mod, conditions = data.frame(size = 1))

```

# Test 2: GLM with `betabin()`

The results seem to be similar to the ones of the GLMM with BRMS, which I still prefer because:

1.  It is multilevel, if I can get it to work it should allow me to account for variability within unbalanced classes. From what I gathered, with unbalanced datasets multilevel models should give me more accurate estimates/bayesian distributions.

    1.  Question: If the random effect is the `ID`, is `betabin()` dealing with variability within the covariates `Type` and `Chronology`?

2.  The random effect `(1|ID)` seems to work in the `brm()` function, whereas it does not in the `betabin()`. I have tried coercing it to factor, passing it just as `~ID`, etc. but I am just getting errors. In theory, if I am able to pass a random effect to this function, it should work as a (frequentist) GLMM.

At this moment, I am trying to understand more about modelling dispersion. Is the dispersion information just provided by the standard error bars in my plots? By providing the parameter `phi` in the `betabin()` call I can set a low (0) to high (0.9) overdispersion. What is then the meaning of the Ï• value provided in the `summary()` of the model? I am not sure I have got correctly the definition of 'modelling dispersion' itself. From what I understood it meant something along the lines of "providing a phi value that allows a better fit". However, I would ideally like to get something like "in Roman rural sites the results are less reliable than another Chronology:Type and fall within this range". 

```{r}
library(aod)

pigs_beta_mod1 <- aod::betabin(
  cbind(Pigs, Tot_NISP - Pigs) ~ Type*Chronology, ~1,
  data = Animals_Df2,
  control = list(maxit = 10000),
  na.action=na.omit,
  phi=0.9
  )

  
pigs_beta_fort <- aod::betabin(
  cbind(Pigs, Tot_NISP - Pigs) ~ Chronology, ~1,
  data = Animals_Df_fort,
  control = list(maxit = 10000),
  na.action=na.omit
  )

pigs_beta_villas <- aod::betabin(
  cbind(Pigs, Tot_NISP - Pigs) ~ Chronology, ~1,
  data = Animals_Df_villas,
  control = list(maxit = 10000),
  na.action=na.omit
  )

summary(pigs_beta_mod1)

```

```{r}
#| echo: false
Mod_Levels <- expand.grid(Type = levels(Animals_Df2$Type),
                     Chronology = levels(Animals_Df2$Chronology))

New.pred <- data.frame(Mod_Levels, 
                       predict(pigs_beta_mod1, 
                               Mod_Levels, 
                               se = TRUE, 
                               type = "response")
                       )

Mod_Levels_fort <- expand.grid(
  Macroregion = levels(Animals_Df_fort$Macroregion),
  Chronology = levels(Animals_Df_fort$Chronology))

New.pred_fort <- data.frame(Mod_Levels_fort, 
                       predict(pigs_beta_fort, 
                               Mod_Levels_fort, 
                               se = TRUE, 
                               type = "response")
                       )

Mod_Levels_villas <- expand.grid(
#  Macroregion = levels(Animals_Df_villas$Macroregion),
  Chronology = levels(Animals_Df_villas$Chronology))

New.pred_villas <- data.frame(Mod_Levels_villas, 
                       predict(pigs_beta_villas, 
                               Mod_Levels_villas, 
                               se = TRUE, 
                               type = "response")
                       )
```

```{r}
#| echo: false

library(ggpubr)
level_order <- c("R", "LR", "EMA", "Ma") 

Pigs_Pred_Plot <-ggplot(New.pred) +
  geom_bar(aes(x=Chronology, 
               y=fit, 
               fill=factor(Chronology, 
                           levels=(level_order))), 
           position="dodge",
           stat="identity",
) +
  scale_fill_grey() +
  geom_errorbar(aes(x=Chronology, 
                    ymin=fit-se.fit, 
                    ymax=fit+se.fit), 
                width=0.2, colour="orange", alpha=0.9, size=0.9)+
  theme_pubclean()+
  labs(
    title=expression(paste("Fitted ", beta, "-binomial GLM: Pigs")),
    subtitle = "Barplot with associated error bars.",
    y="Fitted values",
    fill=""
  )+
  theme(legend.position="bottom") +
  facet_wrap(~ Type)

Pigs_Pred_Plot_fort <-ggplot(New.pred_fort) +
  geom_bar(aes(x=Chronology, 
               y=fit, 
               fill=factor(Chronology, 
                           levels=(level_order))), 
           position="dodge",
           stat="identity",
) +
  scale_fill_grey() +
  geom_errorbar(aes(x=Chronology, 
                    ymin=fit-se.fit, 
                    ymax=fit+se.fit), 
                width=0.2, colour="orange", alpha=0.9, size=0.9)+
  theme_pubclean()+
  labs(
    title=expression(paste("Fitted ", beta, "-binomial GLM: Pigs")),
    subtitle = "Fortified sites- Barplot with associated error bars.",
    y="Fitted values",
    fill=""
  )+
  theme(legend.position="bottom")

Pigs_Pred_Plot_villas <-ggplot(New.pred_villas) +
  geom_bar(aes(x=Chronology, 
               y=fit, 
               fill=factor(Chronology, 
                           levels=(level_order))), 
           position="dodge",
           stat="identity",
) +
  scale_fill_grey() +
  geom_errorbar(aes(x=Chronology, 
                    ymin=fit-se.fit, 
                    ymax=fit+se.fit), 
                width=0.2, colour="orange", alpha=0.9, size=0.9)+
  theme_pubclean()+
  labs(
    title=expression(paste("Fitted ", beta, "-binomial GLM: Pigs")),
    subtitle = "Villas - Barplot with associated error bars.",
    y="Fitted values",
    fill=""
  )+
  theme(legend.position="bottom")

Pigs_Pred_Plot
Pigs_Pred_Plot_fort
Pigs_Pred_Plot_villas
```
